from datetime import date
from io import StringIO

from tests import TEST_DATA_DIR

import pytest

from pipelines import DEFAULT_AWS_REGION, DEFAULT_S3_BUCKET
from pipelines.tasks.departments.department_processor import DepartmentProcessor

VALID_CSV_FILE_PATH = f"{TEST_DATA_DIR}/georef-france-departement.csv"

CSV_HEADER = "Geo Point;Geo Shape;Année;Code Officiel Région;Nom Officiel Région;Code Officiel Département;Code Officiel Courant Département;Nom Officiel Département"
VALID_CSV_CONTENT = """Geo Point;Geo Shape;Année;Code Officiel Région;Nom Officiel Région;Code Officiel Département;Code Officiel Courant Département;Nom Officiel Département
47.63154215229823,6.928576626408644;"{""coordinates"": [[[6.823607588829401, 47.81328395652228], [6.811315031882232, 47.7942891257374], [6.785624100106681, 47.78207608306928], [6.757826303659595, 47.747415994650055], [6.76055245707003, 47.729162795148206], [6.772569697586076, 47.71163527483662], [6.78174479073462, 47.68416968414979], [6.776128718035811, 47.66807906988238], [6.779552282141013, 47.65666651509781], [6.79946809715256, 47.6427276048206], [6.800323742645492, 47.63467689684108], [6.777690989497851, 47.61573884914938], [6.787062839326563, 47.61005162673679], [6.791627506682357, 47.596182427046266], [6.801922070473844, 47.58429171234208], [6.817982005363284, 47.57783548005847], [6.807086799254706, 47.56306637466978], [6.816779797955496, 47.547829336834894], [6.830637430049221, 47.54643559893885], [6.87432798372433, 47.55131688129463], [6.901979459755974, 47.54998157299155], [6.916170260366341, 47.532445797950544], [6.920806257413366, 47.52014449355429], [6.938213678776463, 47.51712375402192], [6.945479133203156, 47.50510442432913], [6.946826300162156, 47.487589122888224], [6.9352247707034, 47.48561696357562], [6.930187923377769, 47.500413102442636], [6.908509208229912, 47.49547934165201], [6.921999770918855, 47.46249031247307], [6.930745653849451, 47.458359245784266], [6.940302981815961, 47.43332305028359], [6.966284396604616, 47.437652042034834], [6.970285775503318, 47.44711007514419], [6.990194620517636, 47.447979029185866], [7.002182484412256, 47.45416312203826], [7.000484843112848, 47.4672016141294], [6.986440188534467, 47.47633093490995], [6.986025946586782, 47.49333940575623], [7.0037369935061, 47.50074612067926], [7.024933770363702, 47.504292941635974], [7.036941367903279, 47.49751468200112], [7.072067968096719, 47.49237664659279], [7.112525326734037, 47.4951087368191], [7.130257331923068, 47.502946799034596], [7.143362828977241, 47.52459142206803], [7.136114265732312, 47.5371601456297], [7.110148846739741, 47.549073922711685], [7.105441637397731, 47.56911917800051], [7.094137132889816, 47.57349707197724], [7.086122690199278, 47.592915279666755], [7.064268011559367, 47.60120036939333], [7.041268174219319, 47.60055831037597], [7.021557354113085, 47.59368496870465], [7.005653227329302, 47.60210401916734], [7.008865588175516, 47.60949406787652], [7.005928740514229, 47.62891989669736], [7.016506374163415, 47.64695474739752], [7.039304430148056, 47.6505051163786], [7.034003430896496, 47.66125121935998], [7.041105469464665, 47.685753407003276], [7.026476379037987, 47.70096315879353], [7.035157696566801, 47.72461957207859], [7.012891894625112, 47.741445522962245], [6.985159124669925, 47.74911300786465], [6.94346605867009, 47.766559383474146], [6.925450563855483, 47.7695603326484], [6.911213357983864, 47.77808416282439], [6.893000715463403, 47.77757031104645], [6.862660469071233, 47.78553649688105], [6.842969791069537, 47.81282241887872], [6.845879068477936, 47.82289379703661], [6.823607588829401, 47.81328395652228]]], ""type"": ""Polygon""}";2022;27;Bourgogne-Franche-Comté;90;90;Territoire de Belfort
48.9177348857,2.47790682097;"{""coordinates"": [[[2.319887174744136, 48.900459782103866], [2.384530045616338, 48.90214759336665], [2.397667826349163, 48.89460619615223], [2.399251617609397, 48.885361950398725], [2.413646198880089, 48.872438026487984], [2.416341130298895, 48.84923378356546], [2.447140124141604, 48.85116257276999], [2.469443562538525, 48.86077408870799], [2.505484355285314, 48.85721238573974], [2.570998787592863, 48.82261547340374], [2.569756340045212, 48.81522272970498], [2.591775429719272, 48.80724968149685], [2.592420640992116, 48.82696325789903], [2.574173842079237, 48.85344391311333], [2.583224927578537, 48.85541564738608], [2.568042805989527, 48.87445003390152], [2.562765212005997, 48.8897138149902], [2.583888943293547, 48.89480000736717], [2.592323124705044, 48.90771503483024], [2.589338090734565, 48.92224897958323], [2.602722440459484, 48.929381294328834], [2.593487516627955, 48.94745254054464], [2.562209663959607, 48.97914246096511], [2.581442925833296, 48.98596791932285], [2.569137206144139, 49.0112831590204], [2.553455632812102, 49.01014140309992], [2.532189253203343, 49.00523793588721], [2.514719023221285, 48.98223116055943], [2.467346398377449, 48.96430605796683], [2.456749082140131, 48.955730866739444], [2.417435655528243, 48.9595237362305], [2.4073555177417, 48.95609221242893], [2.384158680060371, 48.971126044955604], [2.365741943332, 48.974028180518815], [2.336360759801015, 48.95773914510632], [2.32269267279102, 48.95752512903262], [2.298875962416976, 48.966305386496664], [2.290969489575309, 48.95096586466841], [2.329467167688094, 48.94461723431514], [2.333627462202487, 48.927535982397615], [2.313767501815613, 48.914044977151335], [2.319887174744136, 48.900459782103866]]], ""type"": ""Polygon""}";2021;11;Île-de-France;93;93;Seine-Saint-Denis
49.0808802789,-1.32894557747;"{""coordinates"": [[[-1.140276171655211, 49.30875558686156], [-1.114128814321206, 49.32691733740976], [-1.118082843973688, 49.34500820324239], [-1.155167650642998, 49.362292955452965], [-1.160189264040124, 49.35756006259229], [-1.185872545046952, 49.35694087333094], [-1.173781096848064, 49.378608636319974], [-1.162554901998253, 49.389079778493894], [-1.167486801830796, 49.40822670802682], [-1.18820573593612, 49.428744673852705], [-1.219266703720112, 49.45266402669022], [-1.257814954060549, 49.48600552609922], [-1.306639316967747, 49.53929541584011], [-1.309878777533387, 49.54974400750265], [-1.30453196531853, 49.57350806507648], [-1.290023009850581, 49.586073796336244], [-1.266357127078812, 49.59304237893067], [-1.253919921749463, 49.61219238973554], [-1.228942773185854, 49.605783748490246], [-1.228147657331486, 49.62302411634213], [-1.243624653217866, 49.64890085677078], [-1.239610253485977, 49.65436741574481], [-1.263271917989091, 49.67111429878418], [-1.272331528586572, 49.68435463629358], [-1.287850941892215, 49.6926279702047], [-1.357520198799236, 49.70520494778376], [-1.39019061129516, 49.70630058584914], [-1.435961600000387, 49.69974590460151], [-1.456388954242813, 49.691531079467566], [-1.473138645603433, 49.69690363391229], [-1.474713880270777, 49.6820597137376], [-1.488211729303182, 49.66808077699085], [-1.523351027373426, 49.6564039263668], [-1.556312501938467, 49.65394726483684], [-1.568066826340238, 49.65698380391758], [-1.586611591876477, 49.650860209632995], [-1.605651649319861, 49.658445186395866], [-1.619225365297854, 49.63937911527373], [-1.629659964578893, 49.65976322303987], [-1.672490003043365, 49.658118220274574], [-1.683177492795822, 49.67101282418868], [-1.707873056069413, 49.672131692939026], [-1.711897829689234, 49.67825975444097], [-1.758856449671071, 49.67821162369129], [-1.78960337166752, 49.686671168600704], [-1.823225237493731, 49.69016694310769], [-1.839373658940696, 49.71126650432259], [-1.861769853541512, 49.71511834003359], [-1.883519564434592, 49.70589628220267], [-1.906574581046434, 49.722037095322264], [-1.926018527364103, 49.72700209031013], [-1.941832364933967, 49.72559457164339], [-1.946826322779315, 49.70438340676616], [-1.93604842181704, 49.68824242200987], [-1.946514079753016, 49.67797467702924], [-1.916259240146617, 49.66572203039656], [-1.893564010038385, 49.66422723305143], [-1.860943588876132, 49.65035520001445], [-1.854923585213581, 49.64198196684483], [-1.84362598097177, 49.6099221344073], [-1.841717197601138, 49.57735563888893], [-1.846413830470105, 49.56409655075295], [-1.857682761128345, 49.55147776944911], [-1.884739327343747, 49.54126290861002], [-1.886545594913597, 49.52717309405034], [-1.875483279314971, 49.51508381452449], [-1.851426317236252, 49.50961981288954], [-1.845040777808925, 49.49367573787552], [-1.844411112228702, 49.47105005976064], [-1.831075649718166, 49.46228682823293], [-1.82263565421848, 49.43661617208366], [-1.822483390261755, 49.398205987723145], [-1.808413892729601, 49.37213733912679], [-1.789511794546612, 49.37417525917061], [-1.775711150091465, 49.370203867926826], [-1.740849373883025, 49.34408956706934], [-1.723932507748117, 49.3273216071974], [-1.701307464308159, 49.34044116274095], [-1.695512289755805, 49.330863993201355], [-1.707968018013957, 49.31847844770467], [-1.686691591429761, 49.28881356928881], [-1.666650800421248, 49.286970369163974], [-1.676267298401723, 49.27715032779576], [-1.663620933609968, 49.26368560948291], [-1.654040463001211, 49.241183114943674], [-1.640561378558247, 49.22093189699796], [-1.608746458931046, 49.231692265107895], [-1.585255233508933, 49.233360622966835], [-1.575162339976721, 49.22549575675481], [-1.599472316035517, 49.21710968808268], [-1.607370490361697, 49.19628682243554], [-1.601934133505729, 49.181961502751925], [-1.591870279943663, 49.134569030602634], [-1.610277848135628, 49.09902964414315], [-1.609640557926746, 49.08199113919733], [-1.59550388474681, 49.066823659442754], [-1.60287944689405, 49.054472859184486], [-1.594563443478023, 49.02363747688174], [-1.578654808246651, 49.0150461310793], [-1.560761661602264, 49.036151863448744], [-1.554507686041992, 49.026865748058135], [-1.560774866952294, 48.99826387456648], [-1.562427065431809, 48.94150452514608], [-1.543628894787538, 48.93450625407701], [-1.548364615898208, 48.91186957320306], [-1.565140623849977, 48.92115551149584], [-1.575364633117544, 48.87046798786522], [-1.587182533269315, 48.84620147573985], [-1.598103282624929, 48.83944874234617], [-1.5746613143764, 48.8220233689464], [-1.569999015366567, 48.800995464903465], [-1.569839039852641, 48.77447955543935], [-1.57420730420983, 48.755773370542826], [-1.570399306272385, 48.743665090571575], [-1.552853273426664, 48.732762194310666], [-1.528996942994259, 48.729908554120605], [-1.520496196039626, 48.72107079787279], [-1.514776018721859, 48.700339656578734], [-1.496863439033241, 48.683682557317304], [-1.486199858394456, 48.68660447164463], [-1.464144227782604, 48.67396906953843], [-1.432254656918384, 48.666476433357346], [-1.400614894574637, 48.67436396697579], [-1.399403712236964, 48.65499048057625], [-1.377023131140755, 48.65024081670553], [-1.368360420562945, 48.64091074907539], [-1.404011728830386, 48.643741953537585], [-1.425745659963716, 48.63793131361461], [-1.44547814201341, 48.626793843862465], [-1.479539313649448, 48.61822860360759], [-1.515936882563437, 48.61836885631168], [-1.518884279448775, 48.62700182483408], [-1.542683141769581, 48.63113482034333], [-1.570855605611887, 48.62623839516775], [-1.565549104602376, 48.61435778927028], [-1.54401356619783, 48.606076849319685], [-1.537255093893396, 48.598925910127754], [-1.544273979105593, 48.58713300159945], [-1.531626420486219, 48.58092931964051], [-1.518966714209029, 48.56666975581179], [-1.529376769063228, 48.56022305417921], [-1.532958640868712, 48.5461555217874], [-1.522958295982771, 48.54198825540041], [-1.489722033001789, 48.49617731495185], [-1.473638648109224, 48.485287352176954], [-1.449762341445508, 48.4875457103079], [-1.434879836847167, 48.477917686236474], [-1.440980043488194, 48.47198594842062], [-1.421903418710202, 48.46034369387254], [-1.392615562473674, 48.46113201381082], [-1.381410070002385, 48.456760347796084], [-1.365675170618533, 48.46612082818261], [-1.344621643807163, 48.473141205331096], [-1.349453829820612, 48.481690974524234], [-1.322622348754783, 48.499480470683125], [-1.300638295401824, 48.499036654507776], [-1.280900002801131, 48.50837370595468], [-1.269689081361016, 48.5240079901172], [-1.272005344731529, 48.534253382714404], [-1.251788307411661, 48.54378026365554], [-1.238869156228036, 48.537721486953195], [-1.198964844586345, 48.53588665720462], [-1.192894005839489, 48.5288106121015], [-1.169896505920255, 48.53120568916142], [-1.155730888273673, 48.51974465280225], [-1.117232069478498, 48.52171891046978], [-1.103907380937546, 48.51312441427133], [-1.070079830603675, 48.50881739554801], [-1.056052317601272, 48.51329414829325], [-1.018096409874893, 48.49301689472619], [-1.002948090636422, 48.489093405281274], [-0.976931016647319, 48.49299269456783], [-0.962375079758596, 48.50355321267042], [-0.955408560322355, 48.51728361225681], [-0.933484360419595, 48.51495033486895], [-0.922226926219477, 48.502994856644236], [-0.895809287344648, 48.4949100053062], [-0.860278869380722, 48.50151346797279], [-0.847445881651933, 48.52164710918289], [-0.827100038813981, 48.530453335543356], [-0.805711148107977, 48.55070078127593], [-0.793708848234354, 48.550364046825784], [-0.773314291157663, 48.56635376550663], [-0.770040096057929, 48.589686731900606], [-0.752617412105626, 48.5998248580572], [-0.752740349240547, 48.622328776577874], [-0.763096173732572, 48.63137262050535], [-0.773067948398589, 48.657885980626325], [-0.759699108513821, 48.66426552416316], [-0.756942649962558, 48.673557273584485], [-0.736633789667538, 48.679587083815235], [-0.736280843536056, 48.68666950307783], [-0.769467697903708, 48.69528828520001], [-0.798037356168627, 48.709568861196374], [-0.80819845603979, 48.725612707940094], [-0.828241446371064, 48.73366782970523], [-0.849831376398628, 48.73091710911371], [-0.852254251942578, 48.7456518746123], [-0.841185536859379, 48.752381398406435], [-0.832338087135081, 48.76546951225867], [-0.853998527176157, 48.76410568743959], [-0.871672425215214, 48.75572828177528], [-0.902134019908685, 48.76843616746186], [-0.935472289630821, 48.77500306958858], [-0.95128510435459, 48.789192286105774], [-0.97138308521769, 48.78014258819171], [-1.006541551622498, 48.777446767478224], [-1.011583949818252, 48.772074052513], [-1.037742750754869, 48.782787622622315], [-1.060449931414203, 48.77480476273884], [-1.082671363899458, 48.777825634122514], [-1.093641409074813, 48.7841692419599], [-1.09156285488283, 48.79949904882953], [-1.10246003567915, 48.81426567806907], [-1.122673682418913, 48.815669017402264], [-1.159763927822716, 48.82730768474811], [-1.155378024617927, 48.83641303775126], [-1.141946920335607, 48.83750880010734], [-1.114612183380388, 48.8620194793224], [-1.104503946917544, 48.86401036513941], [-1.090924796834505, 48.8793324325213], [-1.076516401842348, 48.869394690066194], [-1.059372822463724, 48.87723314411367], [-1.049361098757956, 48.89417377438534], [-1.024293805494521, 48.90323795534274], [-1.013555898803847, 48.91522865071805], [-1.020695648966935, 48.92756181868577], [-1.041419621532919, 48.921874726072645], [-1.04361539738064, 48.933838601760066], [-1.014125384501719, 48.94097523028067], [-0.9927107211687, 48.94180901093111], [-0.989976343185268, 48.951414620917625], [-0.942788732796213, 48.968048985086554], [-0.910564563517976, 48.99469020335253], [-0.905152305342954, 49.01157346788411], [-0.887039984822186, 49.022317846092335], [-0.863001379227643, 49.02645945890527], [-0.868533965108192, 49.038602976586894], [-0.884808365872063, 49.03862281032843], [-0.892055179744105, 49.047624651728334], [-0.87674675906453, 49.05517976180288], [-0.869350733562823, 49.06763358991219], [-0.871979428790511, 49.08134832416762], [-0.8804760185642, 49.089088738786664], [-0.876113067411682, 49.11184439659821], [-0.893811753619655, 49.117187483018306], [-0.886389978325466, 49.12885012843661], [-0.908260962296826, 49.13904961933854], [-0.922549282128052, 49.141081511408125], [-0.940711017578678, 49.15252152872221], [-0.923923835171224, 49.1661462610209], [-0.915454105505039, 49.178933472160665], [-0.91456896151721, 49.191585002761826], [-0.901041910118888, 49.20291925394365], [-0.925898315293173, 49.22794763598605], [-0.9330607526942, 49.215875595577515], [-0.953094240146659, 49.206708839258695], [-0.954278582762305, 49.20058583092378], [-0.973297304127644, 49.192795244875256], [-1.008060898813487, 49.204230991664204], [-1.024338206271815, 49.20386448196726], [-1.03767621127466, 49.2221518055468], [-1.046330580856745, 49.22127805659016], [-1.078672998629892, 49.23443374486548], [-1.113765148425457, 49.261697815853346], [-1.135530036363153, 49.27009368833911], [-1.121049530394645, 49.281119863652485], [-1.133576976975868, 49.285389141419174], [-1.140276171655211, 49.30875558686156]]], ""type"": ""Polygon""}";2021;28;Normandie;50;50;Manche
"""


@pytest.fixture(scope="session")
def csv_source(source):
    return source


def test_department_processor_is_instantiated(s3):
    dp = DepartmentProcessor(s3)
    dp.init("fake_path.csv", date.today())
    assert dp


@pytest.mark.parametrize(
    "csv_source",
    [
        StringIO(""),
        StringIO(CSV_HEADER),
        f"{TEST_DATA_DIR}/georef-france-departement-empty.csv",
        f"{TEST_DATA_DIR}/empty-file",
    ],
)
def test_department_processor_should_raise_if_empty_csv(s3, csv_source):
    dp = DepartmentProcessor(s3)
    assert dp
    with pytest.raises(ValueError):
        dp.run(csv_source, date.today())


@pytest.mark.parametrize(
    "csv_source",
    [
        StringIO(VALID_CSV_CONTENT),
        VALID_CSV_FILE_PATH,
    ],
)
def test_department_processor_reads_csv(csv_source, s3):
    dp = DepartmentProcessor(s3)
    dp.init(csv_source, date.today())
    assert not dp.departments.empty
    assert "Geo Shape" not in dp.departments.columns
    assert "Geo Point" not in dp.departments.columns


@pytest.mark.parametrize(
    "csv_source",
    [
        StringIO(VALID_CSV_CONTENT),
        VALID_CSV_FILE_PATH,
    ],
)
def test_department_processor_adds_centroid(csv_source, s3):
    dp = DepartmentProcessor(s3)
    dp.init(csv_source, date.today())
    dp.add_centroid()
    assert not dp.departments["centroid"].empty
    assert dp.departments["centroid"].unique().size > 0
    assert dp.departments["centroid"].unique().size == dp.departments.shape[0]


@pytest.mark.parametrize(
    "csv_source",
    [
        StringIO(VALID_CSV_CONTENT),
        VALID_CSV_FILE_PATH,
    ],
)
def test_department_processor_stores_on_s3(csv_source, s3):
    s3.create_bucket(
        Bucket=DEFAULT_S3_BUCKET,
        CreateBucketConfiguration={"LocationConstraint": DEFAULT_AWS_REGION},
    )
    processing_date = date(2022, 11, 3)
    dp = DepartmentProcessor(s3)
    bucket, key = dp.run(csv_source, processing_date)
    assert bucket == DEFAULT_S3_BUCKET
    assert key == "departments_data/departments/20221103.parquet"
    response = s3.get_object(Bucket=bucket, Key=key)
    assert response["ResponseMetadata"]["HTTPStatusCode"] == 200
